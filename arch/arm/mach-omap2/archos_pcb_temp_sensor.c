/*
 * PCB Temperature sensor device file
 *
 * Copyright (C) 2012 ARCHOS S.A.
 *
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU General Public License
 * version 2 as published by the Free Software Foundation.
 *
 * This program is distributed in the hope that it will be useful, but
 * WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program; if not, write to the Free Software
 * Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA
 * 02110-1301 USA
 *
 */

#include <linux/err.h>
#include <linux/slab.h>
#include <linux/io.h>
#include <plat/omap_device.h>
#include "control.h"
#include "pm.h"
#include <plat/pcb_temperature_sensor.h>

#define TWL6030_GPADC_CHANNEL     4

#define ADC_START_VALUE 200
#define ADC_END_VALUE   1190
/*
 * Temperature values in milli degrees celsius
 * 
 * OMAP NTC Gen10
 * Rx = 22k
 * Ry = 470k
 * E-Way EWTF02-104G4A-N 100k B=4050
 * VREF = 1,25V
 */
static int adc_to_temp[] = {
	115407, 115183, 114961, 114741, 114521, 114302, 114085, 113868, 113653,
	113438, 113225, 113013, 112801, 112591, 112382, 112173, 111966, 111760,
	111554, 111350, 111147, 110944, 110742, 110542, 110342, 110143, 109945,
	109748, 109551, 109356, 109161, 108967, 108774, 108582, 108391, 108201,
	108011, 107822, 107634, 107447, 107260, 107074, 106889, 106705, 106521, 
	106338, 106156, 105975, 105794, 105614, 105435, 105257, 105079, 104901,
	104725, 104549, 104374, 104199, 104026, 103852, 103680, 103508, 103337,
	103166, 102996, 102826, 102658, 102489, 102322, 102155, 101988, 101822,
	101657, 101492, 101328, 101165, 101002, 100839, 100677, 100516, 100355,
	100195, 100035, 99876, 99717, 99559, 99401, 99244, 99087, 98931,
	98775, 98620, 98465, 98311, 98157, 98004, 97851, 97699, 97547,
	97396, 97245, 97095, 96945, 96795, 96646, 96497, 96349, 96201,
	96054, 95907, 95760, 95614, 95469, 95323, 95179, 95034, 94890,
	94747, 94603, 94461, 94318, 94176, 94034, 93893, 93752, 93612,
	93472, 93332, 93193, 93054, 92915, 92777, 92639, 92501, 92364,
	92227, 92091, 91955, 91819, 91683, 91548, 91414, 91279, 91145,
	91011, 90878, 90745, 90612, 90480, 90347, 90216, 90084, 89953,
	89822, 89691, 89561, 89431, 89302, 89172, 89043, 88914, 88786,
	88658, 88530, 88402, 88275, 88148, 88021, 87895, 87769, 87643,
	87517, 87392, 87267, 87142, 87017, 86893, 86769, 86645, 86522,
	86399, 86276, 86153, 86030, 85908, 85786, 85664, 85543, 85422,
	85301, 85180, 85060, 84939, 84819, 84699, 84580, 84461, 84342,
	84223, 84104, 83986, 83867, 83750, 83632, 83514, 83397, 83280,
	83163, 83046, 82930, 82814, 82698, 82582, 82466, 82351, 82236,
	82121, 82006, 81891, 81777, 81663, 81549, 81435, 81322, 81208,
	81095, 80982, 80869, 80757, 80644, 80532, 80420, 80308, 80196,
	80085, 79973, 79862, 79751, 79640, 79530, 79419, 79309, 79199,
	79089, 78979, 78870, 78760, 78651, 78542, 78433, 78324, 78216,
	78107, 77999, 77891, 77783, 77675, 77567, 77460, 77353, 77245,
	77138, 77032, 76925, 76818, 76712, 76605, 76499, 76393, 76288,
	76182, 76076, 75971, 75866, 75760, 75655, 75551, 75446, 75341,
	75237, 75132, 75028, 74924, 74820, 74717, 74613, 74509, 74406,
	74303, 74200, 74097, 73994, 73891, 73788, 73686, 73583, 73481,
	73379, 73277, 73175, 73073, 72971, 72870, 72768, 72667, 72566,
	72465, 72364, 72263, 72162, 72061, 71961, 71860, 71760, 71660,
	71560, 71459, 71360, 71260, 71160, 71060, 70961, 70861, 70762,
	70663, 70564, 70465, 70366, 70267, 70168, 70070, 69971, 69873,
	69774, 69676, 69578, 69480, 69382, 69284, 69186, 69088, 68991,
	68893, 68796, 68698, 68601, 68504, 68407, 68310, 68213, 68116,
	68019, 67922, 67826, 67729, 67633, 67536, 67440, 67344, 67247,
	67151, 67055, 66959, 66863, 66768, 66672, 66576, 66481, 66385,
	66290, 66194, 66099, 66004, 65908, 65813, 65718, 65623, 65528,
	65433, 65339, 65244, 65149, 65055, 64960, 64866, 64771, 64677,
	64582, 64488, 64394, 64300, 64206, 64112, 64018, 63924, 63830,
	63736, 63642, 63549, 63455, 63361, 63268, 63174, 63081, 62987,
	62894, 62801, 62708, 62614, 62521, 62428, 62335, 62242, 62149,
	62056, 61963, 61870, 61777, 61685, 61592, 61499, 61406, 61314,
	61221, 61129, 61036, 60944, 60851, 60759, 60667, 60574, 60482,
	60390, 60297, 60205, 60113, 60021, 59929, 59837, 59745, 59653,
	59561, 59469, 59377, 59285, 59193, 59101, 59009, 58918, 58826,
	58734, 58642, 58551, 58459, 58367, 58276, 58184, 58092, 58001,
	57909, 57818, 57726, 57635, 57543, 57452, 57360, 57269, 57177,
	57086, 56994, 56903, 56812, 56720, 56629, 56538, 56446, 56355,
	56264, 56172, 56081, 55990, 55898, 55807, 55716, 55625, 55533,
	55442, 55351, 55260, 55168, 55077, 54986, 54895, 54804, 54712,
	54621, 54530, 54439, 54347, 54256, 54165, 54074, 53982, 53891,
	53800, 53709, 53617, 53526, 53435, 53343, 53252, 53161, 53070,
	52978, 52887, 52796, 52704, 52613, 52521, 52430, 52339, 52247,
	52156, 52064, 51973, 51881, 51790, 51698, 51607, 51515, 51424,
	51332, 51240, 51149, 51057, 50965, 50874, 50782, 50690, 50598,
	50506, 50415, 50323, 50231, 50139, 50047, 49955, 49863, 49771,
	49679, 49587, 49495, 49403, 49310, 49218, 49126, 49034, 48941,
	48849, 48756, 48664, 48571, 48479, 48386, 48294, 48201, 48108,
	48016, 47923, 47830, 47737, 47644, 47551, 47458, 47365, 47272,
	47179, 47086, 46993, 46899, 46806, 46713, 46619, 46526, 46432,
	46339, 46245, 46151, 46058, 45964, 45870, 45776, 45682, 45588,
	45494, 45400, 45305, 45211, 45117, 45022, 44928, 44833, 44739,
	44644, 44549, 44454, 44359, 44264, 44169, 44074, 43979, 43884,
	43789, 43693, 43598, 43502, 43406, 43311, 43215, 43119, 43023,
	42927, 42831, 42735, 42639, 42542, 42446, 42349, 42253, 42156,
	42059, 41962, 41865, 41768, 41671, 41574, 41476, 41379, 41281,
	41184, 41086, 40988, 40890, 40792, 40694, 40596, 40497, 40399,
	40300, 40202, 40103, 40004, 39905, 39806, 39707, 39608, 39508,
	39409, 39309, 39209, 39109, 39009, 38909, 38809, 38708, 38608,
	38507, 38407, 38306, 38205, 38104, 38002, 37901, 37799, 37698,
	37596, 37494, 37392, 37290, 37187, 37085, 36982, 36879, 36776,
	36673, 36570, 36467, 36363, 36260, 36156, 36052, 35948, 35843,
	35739, 35634, 35530, 35425, 35320, 35214, 35109, 35003, 34898,
	34792, 34686, 34579, 34473, 34366, 34259, 34152, 34045, 33938,
	33830, 33723, 33615, 33507, 33398, 33290, 33181, 33072, 32963,
	32854, 32745, 32635, 32525, 32415, 32305, 32194, 32083, 31972,
	31861, 31750, 31638, 31526, 31414, 31302, 31190, 31077, 30964,
	30851, 30737, 30624, 30510, 30396, 30281, 30167, 30052, 29936,
	29821, 29705, 29589, 29473, 29357, 29240, 29123, 29006, 28888,
	28770, 28652, 28534, 28415, 28296, 28177, 28058, 27938, 27818,
	27697, 27576, 27455, 27334, 27212, 27090, 26968, 26846, 26723,
	26599, 26476, 26352, 26227, 26103, 25978, 25853, 25727, 25601,
	25474, 25348, 25221, 25093, 24965, 24837, 24708, 24579, 24450,
	24320, 24190, 24059, 23928, 23797, 23665, 23533, 23400, 23267,
	23133, 22999, 22865, 22730, 22595, 22459, 22323, 22186, 22049,
	21911, 21773, 21634, 21495, 21356, 21215, 21075, 20934, 20792,
	20650, 20507, 20364, 20220, 20075, 19930, 19785, 19639, 19492,
	19345, 19197, 19049, 18899, 18750, 18599, 18448, 18297, 18145,
	17992, 17838, 17684, 17529, 17373, 17217, 17060, 16902, 16744,
	16584, 16424, 16264, 16102, 15940, 15777, 15613, 15448, 15283,
	15116, 14949, 14781, 14612, 14442, 14272, 14100, 13928, 13754,
	13580, 13404, 13228, 13050, 12872, 12693, 12512, 12331, 12148,
	11964, 11780, 11594, 11406, 11218, 11029, 10838, 10646, 10453,
	10259, 10063, 9866, 9668, 9468, 9267, 9065, 8861, 8655,
	8448, 8240, 8030, 7819, 7605, 7391, 7174, 6956, 6736,
	6515, 6291, 6066, 5839, 5610, 5379, 5146, 4910, 4673,
	4434, 4192, 3948, 3702, 3454, 3203, 2950, 2694, 2436,
	2175, 1911, 1644, 1375, 1103, 827, 549, 267, -17,
	-305, -596, -892, -1191, -1493, -1800, -2110, -2425, -2743,
	-3067, -3394, -3727, -4064, -4406, -4754, -5107, -5465, -5829,
	-6200, -6576, -6959, -7349, -7745, -8149, -8561, -8980, -9408,
	-9845, -10291, -10746, -11212, -11688, -12175, -12674, -13185, -13710,
	-14248, -14801, -15370, -15956, -16560, -17182, -17826, -18491, -19181,
	-19896, -20640, -21414, -22222, -23067, -23953, -24885, -25869, -26910,
	-28017, -29200, -30471, -31846, -33345, -34995, -36834, -38916, -41323,
	-44187,
};

static int adc_to_temp_conversion(int adc_val)
{
	if ((adc_val < ADC_START_VALUE) ||
		(adc_val > ADC_END_VALUE)) {
		pr_err("%s:Temp read is invalid %i\n", __func__, adc_val);
		return -EINVAL;
	}

	return adc_to_temp[adc_val - ADC_START_VALUE];
}

// static int adc_to_temp_conversion(int adc_val)
// {
// 	return ((6 * adc_val * adc_val) - 61286 * adc_val + 67989251)/524288;
// }

static struct pcb_temp_sensor_pdata archos_temp_sensor_pdata = {
	.name			= "pcb_temp_sensor",
	.gpadc_channel		= TWL6030_GPADC_CHANNEL,
	.adc_to_temp_conversion	= &adc_to_temp_conversion,
};

static struct platform_device archos_temp_sensor_device = {
	.name		= "pcb_temp_sensor",
	.id		= -1,
	.dev            = {
		.platform_data = &archos_temp_sensor_pdata,
	},
};

int __init archos_pcb_temp_sensor_init(void)
{
	int ret = 0;

	ret = platform_device_register(&archos_temp_sensor_device);
	if (ret) {
		printk(KERN_ERR "Unable to register pcb_temp_sensor platform device\n");
		return -ENODEV;
	}

	return ret;
}
